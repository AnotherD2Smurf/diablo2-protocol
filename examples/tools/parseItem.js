/*
toclient D2GS_ITEMACTIONWORLD 9c04360a1c00000010008000650008e256160682eb811151a0801080062115057443c809ad145a2bb45a684d919891292af08200d07f
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":4,"unknown2":[10,28,0,0,0,16,0,128,0,101,0,8,226,86,22,6,130,235,129,17,81,160,128,16,128,6,33,21,5,116,67,200,9,173,20,90,43,180,90,104,77,145,152,145,41,42,240,130,0,208,127]}
toclient D2GS_ITEMACTIONWORLD 9c04360a1d00000010008000650010e256160682eb811151a060108006e118057443c809ad145a2bb45a684d919891292af08200d07f
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":4,"unknown2":[10,29,0,0,0,16,0,128,0,101,0,16,226,86,22,6,130,235,129,17,81,160,96,16,128,6,225,24,5,116,67,200,9,173,20,90,43,180,90,104,77,145,152,145,41,42,240,130,0,208,127]}
toclient D2GS_ITEMACTIONWORLD 9c0427101e0000001000800065000a2b97e60682eba58910204b8034411e1b0f2dc8285132fd0f
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":4,"unknown2":[16,30,0,0,0,16,0,128,0,101,0,10,43,151,230,6,130,235,165,137,16,32,75,128,52,65,30,27,15,45,200,40,81,50,253,15]}
toclient D2GS_ITEMACTIONWORLD 9c041c101f000000100080006500d032d61603822b0d008c04cada7f
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":4,"unknown2":[16,31,0,0,0,16,0,128,0,101,0,208,50,214,22,3,130,43,13,0,140,4,202,218,127]}
toclient D2GS_ITEMACTIONWORLD 9c0e1410200000001004a008650804d006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,32,0,0,0,16,4,160,8,101,8,4,208,6,87,3,2]}
toclient D2GS_ITEMACTIONOWNED 9d063300210000000001000000110080006524025017060782eb810f706040004024804880688088840214cb3fc2c66463fe03
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[0,33,0,0,0,0,1,0,0,0,17,0,128,0,101,36,2,80,23,6,7,130,235,129,15,112,96,64,0,64,36,128,72,128,104,128,136,132,2,20,203,63,194,198,100,99,254,3]}
toclient D2GS_ITEMACTIONOWNED 9d063101220000000001000000110080006564068057160682eb210d89c0780001cf08e5c4528aa5154b2d96d2c8fee43f
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[1,34,0,0,0,0,1,0,0,0,17,0,128,0,101,100,6,128,87,22,6,130,235,33,13,137,192,120,0,1,207,8,229,196,82,138,165,21,75,45,150,210,200,254,228,63]}
toclient D2GS_ITEMACTIONOWNED 9d062e102300000000010000001100800065c40c2097e60602ac9dd4af74c98c8881850186c189a5144da006ff01
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[16,35,0,0,0,0,1,0,0,0,17,0,128,0,101,196,12,32,151,230,6,2,172,157,212,175,116,201,140,136,129,133,1,134,193,137,165,20,77,160,6,255,1]}
toclient D2GS_ITEMACTIONOWNED 9d0621102400000000010000001100800065e40e2097e60682060d007804cadc7f
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[16,36,0,0,0,0,1,0,0,0,17,0,128,0,101,228,14,32,151,230,6,130,6,13,0,120,4,202,220,127]}
toclient D2GS_ITEMACTIONOWNED 9d063410250000000001000000110080006504118026c606029fb14ad72b2d72122533332c808101c28d15372d789e54e237fc07
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[16,37,0,0,0,0,1,0,0,0,17,0,128,0,101,4,17,128,38,198,6,2,159,177,74,215,43,45,114,18,37,51,51,44,128,129,1,194,141,21,55,45,120,158,84,226,55,252,7]}
toclient D2GS_ITEMACTIONOWNED 9d063210260000000001000000110080006524138067270682ebe10e32705020e07500ca022408ca38c8802083a28041fd07
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[16,38,0,0,0,0,1,0,0,0,17,0,128,0,101,36,19,128,103,39,6,130,235,225,14,50,112,80,32,224,117,0,202,2,36,8,202,56,200,128,32,131,162,128,65,253,7]}
toclient D2GS_ITEMACTIONOWNED 9d063110270000000001000000110080006544154077c60682eb910616907800c1c3868c0f14801160200dca4f423bff01
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[16,39,0,0,0,0,1,0,0,0,17,0,128,0,101,68,21,64,119,198,6,130,235,145,6,22,144,120,0,193,195,134,140,15,20,128,17,96,32,13,202,79,66,59,255,1]}
toclient D2GS_ITEMACTIONWORLD 9c0e1410280000001004a00865080cd006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,40,0,0,0,16,4,160,8,101,8,12,208,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e1410290000001004a000650814d006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,41,0,0,0,16,4,160,0,101,8,20,208,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e14102a0000001004a00865081cd006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,42,0,0,0,16,4,160,8,101,8,28,208,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e14102b0000001004a00865080ed006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,43,0,0,0,16,4,160,8,101,8,14,208,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e14102c0000001004a000650816d006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,44,0,0,0,16,4,160,0,101,8,22,208,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e14102d0000001004a00065081ed006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,45,0,0,0,16,4,160,0,101,8,30,208,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c042b102e0000001000800065005052c7360682eb511749605800814d93270dea4f2c29980d161d2cfc07
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":4,"unknown2":[16,46,0,0,0,16,0,128,0,101,0,80,82,199,54,6,130,235,81,23,73,96,88,0,129,77,147,39,13,234,79,44,41,152,13,22,29,44,252,7]}
toclient D2GS_ITEMACTIONWORLD 9c0e14102f0000001004a0006508008006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,47,0,0,0,16,4,160,0,101,8,0,128,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e1410300000001000a0006508088006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,48,0,0,0,16,0,160,0,101,8,8,128,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e1410310000001000a0086508108006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,49,0,0,0,16,0,160,8,101,8,16,128,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e1410320000001000a0086508188006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,50,0,0,0,16,0,160,8,101,8,24,128,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c0e1410330000001004a008650802d006570302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":14,"unknown2":[16,51,0,0,0,16,4,160,8,101,8,2,208,6,87,3,2]}
toclient D2GS_ITEMACTIONWORLD 9c041e05340000000000c0006500647223460782ab5134c17220d3424505
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":4,"unknown2":[5,52,0,0,0,0,0,192,0,101,0,100,114,35,70,7,130,171,81,52,193,114,32,211,66,69,5]}
toclient D2GS_ITEMACTIONWORLD 9c04201035000000000080006500e0d226460782abd1262da26ce4c704201000
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":4,"unknown2":[16,53,0,0,0,0,0,128,0,101,0,224,210,38,70,7,130,171,209,38,45,162,108,228,199,4,32,16,0]}
toclient D2GS_ITEMACTIONWORLD 9c041805360000000000800065006072f37603822b210302
d2gsToClient :  D2GS_ITEMACTIONWORLD {"entityType":4,"unknown2":[5,54,0,0,0,0,0,128,0,101,0,96,114,243,118,3,130,43,33,3,2]}
toclient D2GS_ITEMACTIONOWNED 9d0630103700000000010000001100800065440410d6560782eb0d88005012a024a034a074822905d30aa6164c7ff41f
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[16,55,0,0,0,0,1,0,0,0,17,0,128,0,101,68,4,16,214,86,7,130,235,13,136,0,80,18,160,36,160,52,160,116,130,41,5,211,10,166,22,76,127,244,31]}
toclient D2GS_ITEMACTIONOWNED 9d06420538000000000100000011008000658408f026160682ebc111323202d006d02050881023c609a314462b8c5a1841b19c92492353544816d42073f67fb4f90f
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[5,56,0,0,0,0,1,0,0,0,17,0,128,0,101,132,8,240,38,22,6,130,235,193,17,50,50,2,208,6,208,32,80,136,16,35,198,9,163,20,70,43,140,90,24,65,177,156,146,73,35,83,84,72,22,212,32,115,246,127,180,249,15]}
toclient D2GS_ITEMACTIONOWNED 9d0630073900000000010000001108800465a40ab0964607328bb001a5018f0bf31f828c133f297e5674b5f891a3fc07
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":6,"unknown2":[7,57,0,0,0,0,1,0,0,0,17,8,128,4,101,164,10,176,150,70,7,50,139,176,1,165,1,143,11,243,31,130,140,19,63,41,126,86,116,181,248,145,163,252,7]}
toclient D2GS_ITEMACTIONOWNED 9d1319103a00000004390000001800a0006518002007830302
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":19,"unknown2":[16,58,0,0,0,4,57,0,0,0,24,0,160,0,101,24,0,32,7,131,3,2]}
toclient D2GS_ITEMACTIONOWNED 9d1319103b00000004390000001800a0006518022007930302
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":19,"unknown2":[16,59,0,0,0,4,57,0,0,0,24,0,160,0,101,24,2,32,7,147,3,2]}
toclient D2GS_ITEMACTIONOWNED 9d1319103c00000004390000001800a0006518042007730302
d2gsToClient :  D2GS_ITEMACTIONOWNED {"unknown1":19,"unknown2":[16,60,0,0,0,4,57,0,0,0,24,0,160,0,101,24,4,32,7,115,3,2]}
*/

const { ProtoDef } = require('protodef')

const item = require('./item.json')
const restBuffer = require('./restBuffer')

const itemParser = require('./itemParser')

const proto = new ProtoDef()

proto.addTypes(item)
proto.addTypes(restBuffer)

function parseEar (buffer, offset, item) {
  if (item.statusInfo.ear === 1) {
    console.log(buffer.slice(offset).toString('hex'))
    console.log(buffer.slice(offset).toString('ascii'))
    const result = proto.parsePacketBuffer('ear', buffer.slice(offset))
    console.log(result)
    item.ear = result.data
    return true
  }
  return false
}

function getItemType () {

}

function getLevelQuality () {

}

function getGraphicInfo () {

}

function getIdentifiedInfo () {

}

function parseDetails (buffer, offset, item) {
  let continueParsing = true;

  ({ offset, continueParsing } = parseEar(buffer, offset, item))
  if (!continueParsing) { return item }
  ({ offset, continueParsing } = getItemType(buffer, offset, item))
  if (!continueParsing) { return item }
  ({ offset, continueParsing } = getLevelQuality(buffer, offset, item))
  if (!continueParsing) { return item }
  offset = getGraphicInfo(buffer, offset, item)
  offset = getIdentifiedInfo(buffer, offset, item)
}

function parseItem (buffer) {
  const data = proto.parsePacketBuffer('D2GS_ITEMACTIONOWNED', buffer)

  let item = data.data

  item = parseDetails(item.details, 0, item)

  return item
}

// const buffer = Buffer.from('9d1319103c00000004390000001800a0006518042007730302', 'hex')
// const buffer = Buffer.from('9d0630103700000000010000001100800065440410d6560782eb0d88005012a024a034a074822905d30aa6164c7ff41f', 'hex')
const buffer = Buffer.from('9d063410250000000001000000110080006504118026c606029fb14ad72b2d72122533332c808101c28d15372d789e54e237fc07', 'hex')
/* const buffer = Buffer.from('9d06420538000000000100000011008000658408f026160682ebc111323202d006d02050881023c609a314462b8c5a1841b19c92492353544816d42073f67fb4f90f', 'hex') */

const parsedItem = itemParser(buffer)

console.log(JSON.stringify(parsedItem, null, 2))

// const parsedItem2 = parseItem(buffer)

// console.log(JSON.stringify(parsedItem2, null, 2))

/*
[
      "container",
      "switch",
      {
        "compareTo": "ground",
        "fields": {
          "1": [
            "container",
            [
              "bitfield",
              [
                {
                  "name": "unk1",
                  "size": "3",
                  "signed": "false"
                },
                {
                  "name": "earLevel",
                  "size": "7",
                  "signed": "false"
                },
                {
                  "name": "unk2",
                  "size": "8",
                  "signed": "false"
                },
                {
                  "name": "earName",
                  "type": [
                    "array",
                    {
                      "count": 16,
                      "type": "lu8"
                    }
                  ]
                }
              ]
            ]
          ]
        },
        "default": "void"
      }
    ],
    [
      "container",
      {
        "name": "type",
        "type": [
          "array",
          {
            "count": 4,
            "type": "lu8"
          }
        ]
      },
      {
        "name": "amount",
        "type": [
          "switch",
          {
            "compareTo": "type",
            "fields": {
              "[103, 108, 100]": [
                "switch",
                {
                  "compareTo": "type",
                  "fields": {
                    "1": "lu32"
                  },
                  "default": [
                    "container",
                    "bitfield",
                    [
                      {
                        "name": "amount",
                        "size": "12",
                        "signed": "false"
                      }
                    ]
                  ]
                }
              ]
            },
            "default": "void"
          }
        ]
      }
    ],
    [
      "container",
      "bitfield",
      [
        {
          "name": "usedSockets",
          "size": "3",
          "signed": "false"
        }
      ]
    ],
    [
      "container",
      "bitfield",
      [
        {
          "name": "level",
          "size": "7",
          "signed": "false"
        },
        {
          "name": "quality",
          "size": "4",
          "signed": "false"
        }
      ]
    ],
    [
      "container",
      [
        "container",
        "bitfield",
        [
          {
            "name": "hasGraphic",
            "size": "1",
            "signed": "false"
          }
        ]
      ],
      {
        "name": "graphic",
        "type": [
          "switch",
          {
            "compareTo": "hasGraphic",
            "fields": {
              "1": [
                "container",
                "bitfield",
                [
                  {
                    "name": "graphic",
                    "size": "3",
                    "signed": "false"
                  }
                ]
              ]
            },
            "default": "void"
          }
        ]
      },
      [
        "container",
        "bitfield",
        [
          {
            "name": "hasColour",
            "size": "1",
            "signed": "false"
          }
        ]
      ],
      {
        "name": "colour",
        "type": [
          "switch",
          {
            "compareTo": "hasGraphic",
            "fields": {
              "1": [
                "container",
                "bitfield",
                [
                  {
                    "name": "colour",
                    "size": "11",
                    "signed": "false"
                  }
                ]
              ]
            },
            "default": "void"
          }
        ]
      }
    ],
    [
      "container",
      "switch",
      {
        "compareTo": "identified",
        "field": {
          "1": [
            "container",
            "switch",
            {
              "compareTo": "quality",
              "fields": {
                "1": [
                  "container",
                  "bitfield",
                  [
                    {
                      "name": "prefix",
                      "size": "3",
                      "signed": "false"
                    }
                  ]
                ],
                "3": [
                  "container",
                  "bitfield",
                  [
                    {
                      "name": "superiority",
                      "size": "3",
                      "signed": "false"
                    }
                  ]
                ],
                "4": [
                  "container",
                  "bitfield",
                  [
                    {
                      "name": "prefix",
                      "size": "11",
                      "signed": "false"
                    },
                    {
                      "name": "suffix",
                      "size": "11",
                      "signed": "false"
                    }
                  ]
                ],
                "5": [
                  "container",
                  "bitfield",
                  [
                    {
                      "name": "setCode",
                      "size": "12",
                      "signed": "false"
                    }
                  ]
                ],
                "6": [
                  "container",
                  "bitfield",
                  [
                    {
                      "name": "prefix",
                      "size": "8",
                      "signed": "false"
                    },
                    {
                      "name": "suffix",
                      "size": "8",
                      "signed": "false"
                    }
                  ]
                ],
                "7": [
                  "switch",
                  {
                    "compareTo": "type",
                    "fields": {
                      "[115, 116, 100]": "void"
                    },
                    "default": [
                      "container",
                      "bitfield",
                      [
                        {
                          "name": "uniqueCode",
                          "size": "12",
                          "signed": "false"
                        }
                      ]
                    ]
                  }
                ],
                "8": [
                  "container",
                  "bitfield",
                  [
                    {
                      "name": "prefix",
                      "size": "8",
                      "signed": "false"
                    },
                    {
                      "name": "suffix",
                      "size": "8",
                      "signed": "false"
                    }
                  ]
                ]
              }
            }
          ]
        },
        "default": "void"
      }
    ]

 */
